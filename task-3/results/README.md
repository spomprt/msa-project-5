# Task 3: CSV Export Service

## Описание проекта

Реализовано java приложение для автоматической выгрузки данных о поставках (shipments) из PostgreSQL базы данных в CSV формат с использованием Kubernetes CronJob для планирования задач.

## Архитектура решения

### Компоненты системы

1. **Java приложение** (`csv-exporter/`)
   - Подключение к PostgreSQL базе данных
   - Экспорта данных в CSV

2. **Kubernetes инфраструктура** (`k8s/`)
   - CronJob для автоматического запуска экспорта
   - PersistentVolume для хранения CSV файлов
   - ConfigMap и Secret для конфигурации
   - Namespace для изоляции ресурсов

3. **Результаты экспорта** (`results/csv/`)
   - Сгенерированные CSV файлы с данными о поставках
   - Скрипт синхронизации файлов из minikube

## Функциональность

### Основные возможности

- **Экспорт всех поставок** - выгрузка всех записей из таблицы shipments
- **Автоматическое именование файлов** - с временной меткой для уникальности
- **Планировщик задач** - автоматический запуск по расписанию (каждую минуту для тестирования)

### Модель данных

CSV файлы содержат следующие поля:
- `ID` - уникальный идентификатор поставки
- `Description` - описание поставки
- `Status` - текущий статус (pending, shipped, delivered, in transit)
- `Created At` - дата и время создания записи

## Технические детали

### Java приложение

**Основные классы:**
- `CsvExporterApplication` - главный класс приложения
- `CsvExportService` - сервис для экспорта данных
- `ShipmentRepository` - репозиторий для работы с БД
- `Shipment` - модель данных поставки

### Kubernetes конфигурация

**Ресурсы:**
- `CronJob` - планировщик задач (расписание: `* * * * *`)
- `PersistentVolume` - хранилище для CSV файлов (1Gi)
- `ConfigMap` - конфигурация приложения
- `Secret` - учетные данные БД
- `Namespace` - изоляция ресурсов (`shipment-db`)

**Переменные окружения:**
- `DB_HOST` - хост PostgreSQL (postgres-service)
- `DB_PORT` - порт БД (5432)
- `DB_NAME` - имя базы данных (shipment)
- `DB_USER` - пользователь БД (shipment)
- `OUTPUT_DIR` - директория для экспорта (/app/exports)
- `EXPORT_TYPE` - тип экспорта (all/status)

## Результаты работы

### Сгенерированные файлы

В папке `results/csv/` находятся следующие файлы:
- `all_shipments_20250927_114405.csv` - экспорт от 27.09.2025 11:44:05
- `all_shipments_20250927_114406.csv` - экспорт от 27.09.2025 11:44:06
- `all_shipments_20250927_114501.csv` - экспорт от 27.09.2025 11:45:01
- `all_shipments_20250927_114601.csv` - экспорт от 27.09.2025 11:46:01
- `all_shipments_20250927_114701.csv` - экспорт от 27.09.2025 11:47:01
- `all_shipments_20250927_114801.csv` - экспорт от 27.09.2025 11:48:01

### Скрипт синхронизации

`sync-csv.sh` - скрипт для копирования CSV файлов из minikube на хост-машину:
```bash
#!/bin/bash
# Скрипт для синхронизации CSV файлов из minikube на хост
# Получает список файлов и копирует их локально
```

## Запуск и использование

### Сборка приложения
```bash
cd csv-exporter
mvn clean package
docker build -t csv-exporter:latest .
```

### Развертывание в Kubernetes
```bash
# Применение всех манифестов
kubectl apply -f k8s/

# Проверка статуса CronJob
kubectl get cronjobs -n shipment-db

# Просмотр логов
kubectl logs -f job/csv-exporter-cronjob-<timestamp> -n shipment-db
```
